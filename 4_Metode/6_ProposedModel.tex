\subsection{Proposed Model}
\label{sec:Method:ProposedModel}
The proposed model expands on the concept of a constant velocity model. Therefore this section will first introduce the constant velocity model as the base case for modelling node pair interactions, as presented by Simon Tommerup\cite{Tommerup2021LearningNetworks}. Then the actual proposed model, the stepwise constant velocity model, will be introduced as a more flexible way of modelling node pair interactions.  Finally it will be shown how the stepwise constant velocity model can be vectorized to make it scalable for use with frameworks like Pytorch and how regularization of the velocities in the stepwise model can be utilized to try and control the changes in the learned velocities from one step in the model to another, which is desirable for later visualizing the node movements in the latent space.


\subsubsection{Constant Velocity base Model}
\label{sec:Method:ProposedModel:ConstantVelocityModel}
The constant velocity model tries to determine the common bias term, initial position and initial velocity for N nodes in a TDGN, based on the pairwise node interactions happening over a given timespan.
\\\\
The model takes as input a chronologically ordered sequence of $n$ timestamped, pairwise node interactions, which are stored as $n$ tuples $(u_i, v_i, t_i)$.
Here, $u_i$ and $v_i$ denote the two interacting nodes for interaction $i$, and $t_i$ denotes the time of the interaction.
\\
The learnable parameters of the model are the set of parameter matrices $\textbf{Z}, \textbf{V} \in \mathbb{R} ^{N \times 2}$ as well as the bias term $\beta \in \mathbb{R}$.
The parameter matrix $\textbf{Z}$ contains starting positions for all $N$ nodes in the TDGN, holding the $x$-component in the first column, and the $y$-component in the second.
The same is true for $\textbf{V}$, just that it contains all node velocities, which hence are constant over the given timespan.
The bias term $\beta$, as explained in section \ref{sec:Method:IntensityFunc}, is a real number used in modelling the background intensity of interactions.
\\\\
Each pair of nodes, $u$ and $v$, are associated with a Poisson point process, described under section \ref{sec:Method:Poisson:PoissonPointProcess}.
These processes are each governed by an intensity function (\ref{eq:IntensityFunc}), described under section \ref{sec:Method:IntensityFunc}, which explains that the closer $u$ and $v$ are, the higher the intensity of interaction will be. 
These pairwise intensity functions are utilized in the log-likelihood function (\ref{eq:LogLikelihoodFuncExplicit}), described under section \ref{sec:Method:LikelihoodFunc}, which outputs the log-likelihood of the input data given the parameters of the model, matrices $\textbf{Z}$ and $\textbf{V}$, and the common bias $\beta$.
\\
The optimization problem of the model is to maximize the log-likelihood (in practice minimize the negative log-likelihood) of the input data by fitting the model parameters.
In this regard, the goal is to learn the true initial conditions, $\textbf{Z}, \textbf{V}, \beta$.

\paragraph{Latent Space Position Calculation}
Given a set of node pair interactions and the time of each interaction, the constant velocity model then calculates the latent space node position for a node $u$ at interaction time $t$ as:
\begin{equation}
    \textbf{z}_{u}(t) = 
    \begin{pmatrix}
        x_{u}(t) \\
        y_{u}(t)
    \end{pmatrix}
    =
    \begin{pmatrix}
        z_{u,x}+v_{u,x} \cdot t \\
        z_{u,y}+v_{u,y} \cdot t
    \end{pmatrix}
    \;\; , \;\; \textbf{z}_{u}(t)
    \label{eq:Method:ConstantVelocity:latent_pos}
\end{equation}
Where the subscripts $(u,x)$ and $(u,y)$ denotes the $x$ and $y$ dimension of node $u$.

\paragraph{Loss Function}
The loss function of the constant velocity model is comprised of two parts here named \textit{event intensity} and \textit{non-event intensity}. The event intensity is defined as the sum of intensities for all node pairs for each of their node interaction times in the input data. The non-event intensity is defined as the sum of intensities for all node pairs in the time span from 0 to the max time in the input independent of whether or not the node pairs have an event in the input data. 
The event intensity $I_e$ for an input of $n$ node pair interactions is calculated based on the sum of log intensities for each node pair which depends on the node pairwise distances according to the found latent space positions for each node pair at the time of their interaction computed in the constant velocity model as:
\begin{equation}
    I_e = \sum_{i = 0}^{n-1}  \lambda_{u_i , v_i}(t_i) =  \sum_{i =0}^{n-1} \beta - \rVert \textbf{z}_{u_i}(t_i) - \textbf{z}_{v_i}(t_i) \rVert_2^2
    \label{eq:Method:ProposedModel:event_intensity_calc}
\end{equation}
Where $\rVert \cdot \rVert_2^2$ is the squared Euclidean distance, $\beta$ is the common bias term, $\textbf{z}_{u_i , t_i}$ is the latent space position of node $u_i$ at interaction time $t_i$ as described in (\ref{eq:latent_pos}).
\\\\
The non-event intensity $I_n$ for $n$ node pair interactions is simply computed by directly implementing the analytical solution to the constant velocity intensity integral (\ref{eq:analytical_integral}) from section \ref{sec:Method:IntensityFunc:IntegralIntensityFunc} and summing over it for all node pairs using the model starting positions and velocities in $\textbf{Z}$ and $\textbf{V}$:
\begin{equation}
    I_n = \sum_{u=0}^{N-2} \sum_{v > u}^{N-1} \varphi_{u,v}(t_0,t_{max}) 
    \label{eq:Method:ProposedModel:nonevent_intensity_calc}
\end{equation}
Where $\varphi$ is the analytical solution to the constant velocity intensity integral evaluated for the start time $t_0=0$ and end time $t_{max}$ which is the latest node pair interaction time.
\\\\
The constant velocity model loss is then computed as
$$
\mathcal{L} = - I_e - I_n
$$
which is the negative log likelihood.

\subsubsection{Stepwise Constant Velocity Model (SCVM)}
\label{sec:Method:ProposedModel:PiecewiseConstantVelocityModel}

With the constant velocity model, it is possible to model interactions between $N$ nodes in a TDGN by finding their true starting positions and velocities, as well as the bias term $\beta$, for a given timespan.
\\\\
The positions of nodes are modelled to change, reflecting the change in intensity of interaction between nodes, starting in $\textbf{Z}$ at time $t=0$ and moving along the trajectories that result from the constant velocities $\textbf{V}$ over time, until end time $T$.
With only one set of parameters for the entire timespan of a TDGN, the modelling ability is limited to describing changes in intensity of interaction with only changes in positions, along the straight trajectories of the velocity vectors contained in $\textbf{V}$.
This will in many cases be insufficient for depicting the given TDGN in a useful manner. 
In order to model with greater detail, the Constant Velocity Model is therefore expanded to the Stepwise Constant Velocity Model (SCVM). 
The central idea with this model is to split the entire timespan of a TDGN into $S$ smaller time intervals where the node movements in each sub interval, or step, is modelled by a velocity vector. The model still relies on a single common bias term $\beta$, and a single set of node starting positions $\textbf{Z} \in \mathbb{R}^{N \times 2}$, but the velocity is expanded with another dimension $S$ corresponding to the number of steps, such that $\textbf{V} \in \mathbb{R}^{N \times 2 \times S}$.
Having several velocities should allow for the TDGN to be modelled in a much more detailed manner, and should result in better representations in the Euclidean latent space.
\\\\
This enables for an expansion of the visualization made in section \ref{sec:Method:VModel:ModellingApproach}, in which the TDGN was visually understood as nodes starting in one point and travelling on a straight path in Euclidean latent space.
Now, by having the nodes move according to the sequence of velocities contained in the SCVM, the nodes will be able to travel on non-linear paths through the Euclidean latent space.
The complexity of their movements will hence depend on the number of steps, $S$, with larger $S$ leading to more possible velocity changes.

\subsubsection{Model Step Size}
The model is given a notion of how much time a step in the $S$ dimension corresponds to which can be used to compute latent space node positions at specific time points. For simplicity the model assumes equal size for each step and that the start time is 0. Such that only a single step size is needed for the model:
\begin{equation}
    \Delta_{step} = \frac{t_{max}}{S}
\end{equation}
Where $t_{max}$ is the max time from the event interactions.

\paragraph{Latent Space Position Calculation}
\label{sec:Method:StepwiseLatentSpacePositions}
The idea of adding a step dimension to the velocity matrix means a slight change in how the latent node positions for each interaction time are computed. Expanding on the idea from the constant velocity position calculation (\ref{eq:Method:ConstantVelocity:latent_pos}) we add the notion of the model step size $\Delta_{step}$ and the extra dimension to $\textbf{V}$ of size $S$. 
We then define the latent space movement of a node $u$ to a time point t, with $0 < t \le t_{max}$, as the sum of movements from each step:
\begin{equation}
    \mathcal{M}_{u}(t) = \sum_{j = 1}^{S} \textbf{v}_{j, u} \cdot \Delta_{j}(t) \;\;,\;\; \mathcal{M}_{u} \in \mathbb{R}^2
    \label{eq:Method:ConstantVelocity:Movement}
\end{equation}
Where $\textbf{v}_{j,u}$ is the $j$'th step velocity for node $u$, and $\Delta_{j}(t)$ is the portion of $t$ that falls into step $j$ i.e.:
\begin{align}
    \Delta_{j}(t) = 
    \begin{cases}
        \Delta_{step} \;\; &\text{for} \;\; t \ge \Delta_{step} \cdot j\\
        \text{max}\left(0, t + \Delta_{step} - \Delta_{step} \cdot j\right) \;\; &\text{for} \;\; t < \Delta_{step} \cdot j
   \end{cases} \;\; , \;\; j \in \{1,2,...,S\}
   \label{eq:delta_t}
\end{align}
\\
We then get the latent node position for a given node $u$ to time $t$ as:
\begin{equation}
    \textbf{z}_{u}(t) = 
    \begin{pmatrix}
        x_{u}(t) \\
        y_{u}(t)
    \end{pmatrix}
    =
    \begin{pmatrix}
        z_{u,x} + \mathcal{M}_{u,x}(t) \\
        z_{u,y}+ \mathcal{M}_{u,y}(t)
    \end{pmatrix}
    \;\; \text{for} \;\; \mathcal{M}_{u_i,x}(t) \;,\; \mathcal{M}_{u_i,y}(t) \in \mathbb{R}
    \label{eq:Method:ConstantVelocity:latent_pos}
\end{equation}
Which is similar to (\ref{eq:Method:ConstantVelocity:latent_pos}), but where $\mathcal{M}_{u,x}$ and $\mathcal{M}_{u,y}$ represent node $u$'s summed stepwise movements in the $x$ and $y$ direction from time 0 to time $t$.


\paragraph{Loss Function}
The loss function of the stepwise model loss function remains identical to that of the constant velocity model, since the event and non-event intensities $I_e$ and $I_n$ can still be calculated as in (\ref{eq:Method:ProposedModel:event_intensity_calc}) and (\ref{eq:Method:ProposedModel:nonevent_intensity_calc}). The only difference will be, that the latent space positions used to calculate the event intensities are computed using the method described in section \ref{sec:Method:StepwiseLatentSpacePositions}.


\subsubsection{Position and Drift Correction}
\label{sec:Method:ProposedModel:PositionCorrection}
Since the model is only fitted based on the relative node distances, and velocity changes if regularization is used. This means that the model is unaware of the exact values of the starting positions and velocities $\textbf{Z}$ and $\textbf{V}$ as long as the relative node distances produce a good fit. This also means that the model fitting can result in displacement from origo of the node starting positions and that drift can be introduced in the node positions, which is undesirable when visualizing the node behavior in latent space.
\\
But, it is possible to center the model and remove drift while preserving the model loss and there by produce a more understandable visualization. 
To center the node positions around origo the coordinate-wise mean of $\textbf{Z}$
\begin{equation}
        \overline{\textbf{z}} = 
    \begin{pmatrix}
        \overline{z}_x \\
        \overline{z}_y
    \end{pmatrix}
\end{equation}
is subtracted from the starting positions in $\textbf{Z}$. Then the squared Euclidean distance between a node pair becomes:
\begin{equation}
    \mathcal{D} =\rVert (\textbf{z}_u-\overline{\textbf{z}}) - (\textbf{z}_v-\overline{\textbf{z}}) \rVert_2^2 = 
    \rVert \textbf{z}_u - \textbf{z}_v \rVert_2^2 
\end{equation}
and stays unaffected.
\\\\
The same procedure is applied to the velocities $\textbf{V}$, which means that the node movement for a node $u_i$ now becomes:
\begin{align}
    M_u(t) &= \sum_{j=1}^S \left[(\textbf{v}_{j,u} - \overline{\textbf{v}}_j) \cdot \Delta_{j}(t) \right] \\
    &= \sum_{j=1}^S \textbf{v}_{j, u} \cdot \Delta_{j}(t) - \sum_{j=1}^S \overline{\textbf{v}}_j \cdot \Delta_{j}(t) \\
    &= \mathcal{M}_u(t) - \sum_{j=1}^S \overline{\textbf{v}}_j \cdot \Delta_{j}(t)
\end{align}
Where $\mathcal{M}_u(t)$ comes from equation
(\ref{eq:Method:ConstantVelocity:Movement}).
\\
For brevity we define:
\begin{equation}
    \overline{\mathcal{M}}(t) = \sum_{j=1}^S \overline{\textbf{v}}_j \cdot \Delta_{j}(t) \;\;,\;\; \overline{\mathcal{M}}(t) \in \mathbb{R}^{2}
\end{equation}
The new latent space position of node $u$ at time $t$ then becomes:
\begin{equation}
    \textbf{p}_u(t) = 
     \begin{pmatrix}
        z_{u,x} + \mathcal{M}_{u,x}(t) - \overline{\mathcal{M}}_{x}(t) \\
        z_{u,y}+ \mathcal{M}_{u,y}(t) - \overline{\mathcal{M}}_{y}(t)
    \end{pmatrix} =
    \textbf{z}_u(t) - \overline{\mathcal{M}}
\end{equation}
And the latent distance measure for a node pair $u$ and $v$:
\begin{align}
     \mathcal{D} &= \rVert \textbf{p}_u(t) - \textbf{p}_v(t) \rVert_2^2 \\
     &= \left\rVert \left(\textbf{z}_u(t)-\overline{\mathcal{M}}) - (\textbf{z}_v(t)-\overline{\mathcal{M}}\right) \right\rVert_2^2 \\
     &= \rVert \textbf{z}_u(t) - \textbf{z}_v(t) \rVert_2^2 
\end{align}
remains intact.

\subsubsection{Rotation Correction}
\label{sec:Method:ProposedModel:RotationCorrection}


\subsubsection{Extending Loss Function - Regularization of Velocity Changes}
\label{sec:Method:ProposedModel:Regularization}
The velocity from one step to another can change a lot. But, large changes in velocity can have a negative impact on the visualization of the node behavior in latent space e.g. if nodes dramatically speed up and down from step to step.
Therefore a regularization term is added to the model loss function which penalizes high changes in velocities from one step to the next:
\begin{align}
    \mathcal{L} = - (I_e - I_n) + \gamma \sum_{i=1}^{S} \rVert (\textbf{V}_i - \overline{\textbf{V}}_i) - (\textbf{V}_{i-1} - \overline{\textbf{V}}_{i-1}) \rVert_{F}^{2}
    \label{eq:Method:ProposedModel:vec_regularization}
\end{align}
Where $\gamma$ is the regularizatoin factor and $\rVert \cdot \rVert_F^2$ is the squared Frobenius norm. Because of the position correction which subtracts the mean from the starting positions and the veolicities, the mean is also subtracted from the velocities in the regularization to make it center invariant.



